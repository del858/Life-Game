<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Life Game • Играй свою жизнь</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #007AFF;
            --primary-light: #409CFF;
            --primary-dark: #0056CC;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --background-light: #F2F2F7;
            --background-dark: #1C1C1E;
            --card-light: #FFFFFF;
            --card-dark: #2C2C2E;
            --text-light: #000000;
            --text-dark: #FFFFFF;
            --border-light: #C7C7CC;
            --border-dark: #38383A;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-dark: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        body.light-theme {
            background-color: var(--background-light);
            color: var(--text-light);
        }

        body.dark-theme {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Typography */
        h1, h2, h3, h4 {
            font-weight: 600;
            line-height: 1.2;
        }

        h1 {
            font-size: 1.5rem;
        }

        h2 {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
        }

        h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        h4 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        p {
            margin-bottom: 1rem;
        }

        /* Navigation */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid;
            margin-bottom: 2rem;
        }

        body.light-theme .top-nav {
            border-color: var(--border-light);
        }

        body.dark-theme .top-nav {
            border-color: var(--border-dark);
        }

        .nav-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .app-title i {
            color: var(--primary-color);
            font-size: 1.5rem;
        }

        .nav-items {
            display: flex;
            gap: 1.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s;
        }

        body.light-theme .nav-item {
            color: var(--text-light);
        }

        body.dark-theme .nav-item {
            color: var(--text-dark);
        }

        .nav-item.active {
            background-color: var(--primary-color);
            color: white !important;
        }

        .nav-item:hover:not(.active) {
            background-color: rgba(0, 122, 255, 0.1);
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .xp-display {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 10px;
        }

        body.light-theme .xp-display {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .xp-display {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .level-badge {
            text-align: center;
        }

        .level-label {
            display: block;
            font-size: 0.75rem;
            opacity: 0.7;
            margin-bottom: 0.25rem;
        }

        .level-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .xp-progress {
            min-width: 150px;
        }

        .xp-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        body.light-theme .xp-bar {
            background-color: rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .xp-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            border-radius: 3px;
            width: 0%;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        .coins-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            color: #FFD700;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        body.light-theme .icon-btn {
            color: var(--text-light);
        }

        body.dark-theme .icon-btn {
            color: var(--text-dark);
        }

        .icon-btn:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
        }

        .btn-secondary:hover {
            background-color: rgba(0, 122, 255, 0.2);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        body.light-theme .btn-icon {
            color: var(--text-light);
        }

        body.dark-theme .btn-icon {
            color: var(--text-dark);
        }

        .btn-icon:hover {
            background-color: rgba(0, 122, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            position: relative;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .section-subtitle {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 0;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            opacity: 0.7;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: 1px solid;
            font-size: 0.9rem;
            min-width: 150px;
            background-color: transparent;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }

        body.light-theme .filter-select {
            border-color: var(--border-light);
            color: var(--text-light);
            background-color: var(--card-light);
        }

        body.light-theme .filter-select option {
            background-color: var(--card-light);
            color: var(--text-light);
        }

        body.dark-theme .filter-select {
            border-color: var(--border-dark);
            color: var(--text-dark);
            background-color: var(--card-dark);
        }

        body.dark-theme .filter-select option {
            background-color: var(--card-dark);
            color: var(--text-dark);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Projects Grid */
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            padding: 1.5rem;
            border-radius: 15px;
            transition: all 0.3s;
            position: relative;
        }

        body.light-theme .project-card {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .project-card {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .project-card:hover {
            transform: translateY(-2px);
        }

        body.light-theme .project-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        body.dark-theme .project-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }

        .project-card.overdue {
            border-left: 4px solid var(--danger-color);
        }

        .project-card.soon {
            border-left: 4px solid var(--warning-color);
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .project-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .project-category {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .project-description {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 1.5rem;
        }

        .project-progress {
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        body.light-theme .progress-bar {
            background-color: rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .progress-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
        }

        .project-deadline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .deadline-overdue {
            color: var(--danger-color);
            font-weight: 600;
        }

        .deadline-soon {
            color: var(--warning-color);
            font-weight: 600;
        }

        .project-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .project-tasks {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid;
        }

        body.light-theme .project-tasks {
            border-color: rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .project-tasks {
            border-color: rgba(255, 255, 255, 0.1);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        body.light-theme .task-checkbox {
            border-color: var(--border-light);
        }

        body.dark-theme .task-checkbox {
            border-color: var(--border-dark);
        }

        .task-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .task-checkbox i {
            font-size: 0.9rem;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .task-item:hover {
            background-color: rgba(0, 122, 255, 0.05);
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .task-text {
            flex: 1;
            word-break: break-word;
        }

        .task-xp-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            background-color: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
            font-weight: 600;
            flex-shrink: 0;
        }

        /* Habits */
        .habits-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .today-habits .habits-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .habit-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            transition: all 0.2s;
            cursor: pointer;
        }

        body.light-theme .habit-item {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .habit-item {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .habit-item:hover {
            transform: translateY(-1px);
        }

        .habit-checkbox {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        body.light-theme .habit-checkbox {
            border-color: var(--border-light);
        }

        body.dark-theme .habit-checkbox {
            border-color: var(--border-dark);
        }

        .habit-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }

        .habit-checkbox i {
            font-size: 0.9rem;
        }

        .habit-info {
            flex: 1;
        }

        .habit-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .habit-xp {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .weekly-overview .week-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .week-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        body.light-theme .week-day {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .week-day {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .week-day.completed {
            background-color: var(--success-color);
            color: white;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        body.light-theme .stat-card {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .stat-card {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background-color: rgba(0, 122, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .stat-info {
            flex: 1;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .chart-container {
            padding: 1.5rem;
            border-radius: 15px;
            margin-top: 2rem;
        }

        body.light-theme .chart-container {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .chart-container {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .progress-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .project-progress-item {
            margin-bottom: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .achievement-card {
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s;
        }

        body.light-theme .achievement-card {
            background-color: var(--card-light);
            box-shadow: var(--shadow-light);
        }

        body.dark-theme .achievement-card {
            background-color: var(--card-dark);
            box-shadow: var(--shadow-dark);
        }

        .achievement-card:hover {
            transform: translateY(-2px);
        }

        .achievement-card.locked {
            opacity: 0.5;
            filter: grayscale(0.5);
        }

        .achievement-card.earned {
            border: 2px solid var(--success-color);
        }

        .achievement-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .achievement-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .achievement-desc {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 1rem;
        }

        .achievement-status {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .achievement-summary {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 350px;
            height: 100vh;
            padding: 1.5rem;
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }

        body.light-theme .settings-panel {
            background-color: var(--card-light);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }

        body.dark-theme .settings-panel {
            background-color: var(--card-dark);
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .settings-panel.active {
            right: 0;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .setting-group {
            margin-bottom: 1.5rem;
        }

        .theme-options {
            display: flex;
            gap: 1rem;
        }

        .theme-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 10px;
            background: none;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        body.light-theme .theme-option {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-theme .theme-option {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .theme-option.active {
            border-color: var(--primary-color);
            background-color: rgba(0, 122, 255, 0.1);
        }

        .theme-option i {
            font-size: 1.5rem;
        }

        .categories-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 10px;
        }

        body.light-theme .category-item {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-theme .category-item {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .category-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .category-name {
            flex: 1;
            font-weight: 600;
        }

        .add-category {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .add-category input[type="text"] {
            flex: 1;
            padding: 0.75rem;
            border-radius: 10px;
            border: 1px solid;
            background-color: transparent;
            min-width: 150px;
        }

        body.light-theme .add-category input[type="text"] {
            border-color: var(--border-light);
            color: var(--text-light);
        }

        body.dark-theme .add-category input[type="text"] {
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        .add-category input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .data-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 15px;
            padding: 1.5rem;
        }

        body.light-theme .modal-content {
            background-color: var(--card-light);
        }

        body.dark-theme .modal-content {
            background-color: var(--card-dark);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            border: 1px solid;
            font-size: 0.9rem;
            background-color: transparent;
        }

        body.light-theme .form-group input,
        body.light-theme .form-group textarea,
        body.light-theme .form-select {
            border-color: var(--border-light);
            color: var(--text-light);
            background-color: var(--card-light);
        }

        body.light-theme .form-select option {
            background-color: var(--card-light);
            color: var(--text-light);
        }

        body.dark-theme .form-group input,
        body.dark-theme .form-group textarea,
        body.dark-theme .form-select {
            border-color: var(--border-dark);
            color: var(--text-dark);
            background-color: var(--card-dark);
        }

        body.dark-theme .form-select option {
            background-color: var(--card-dark);
            color: var(--text-dark);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        #tasks-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .task-input {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .task-input input[type="text"] {
            flex: 2;
        }

        .task-input input[type="number"] {
            flex: 1;
            min-width: 80px;
        }

        .radio-group {
            display: flex;
            gap: 1rem;
        }

        .radio-option {
            flex: 1;
            padding: 1rem;
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        body.light-theme .radio-option {
            background-color: rgba(0, 0, 0, 0.05);
        }

        body.dark-theme .radio-option {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option input[type="radio"]:checked + span {
            color: var(--primary-color);
            font-weight: 600;
        }

        .radio-option input[type="radio"]:checked ~ span {
            color: var(--primary-color);
            font-weight: 600;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Mobile Navigation */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .mobile-nav-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .mobile-nav-overlay.active {
            display: block;
        }

        .mobile-nav-content {
            position: fixed;
            top: 0;
            right: 0;
            width: 280px;
            height: 100%;
            background-color: var(--card-light);
            padding: 2rem;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        body.dark-theme .mobile-nav-content {
            background-color: var(--card-dark);
        }

        .mobile-nav-overlay.active .mobile-nav-content {
            transform: translateX(0);
        }

        .mobile-nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .mobile-nav-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .mobile-nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 10px;
            text-decoration: none;
            color: var(--text-light);
            transition: all 0.2s;
        }

        body.dark-theme .mobile-nav-item {
            color: var(--text-dark);
        }

        .mobile-nav-item.active {
            background-color: var(--primary-color);
            color: white !important;
        }

        .mobile-nav-item:hover:not(.active) {
            background-color: rgba(0, 122, 255, 0.1);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .top-nav {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
                padding: 1rem 0;
            }
            
            .nav-left {
                flex-direction: column;
                gap: 1rem;
            }
            
            .nav-items {
                display: none;
            }
            
            .nav-right {
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            
            .xp-display {
                order: 1;
                width: 100%;
                justify-content: space-between;
                padding: 0.75rem;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .btn-text {
                display: none;
            }
            
            .projects-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .habits-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .achievements-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .filters {
                flex-direction: column;
                gap: 1rem;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-select {
                width: 100%;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .settings-panel {
                width: 100%;
                right: -100%;
            }
            
            .modal-content {
                padding: 1rem;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-text {
                display: none;
            }
            
            .level-badge {
                min-width: 60px;
            }
            
            .xp-progress {
                min-width: 120px;
            }
            
            .project-card {
                padding: 1rem;
            }
            
            .project-actions {
                flex-wrap: wrap;
            }
            
            .achievement-card {
                padding: 1rem;
            }
            
            .mobile-nav-content {
                width: 250px;
                padding: 1.5rem;
            }
            
            .toast {
                left: 15px;
                right: 15px;
                bottom: 15px;
                text-align: center;
            }
        }

        /* Animation for checkbox */
        @keyframes checkmark {
            0% {
                transform: scale(0);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .task-checkbox.checked i,
        .habit-checkbox.checked i {
            animation: checkmark 0.2s ease;
        }

        /* Loading animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #8E8E93;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .empty-state p {
            margin-bottom: 1.5rem;
        }

        .debug-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 9999;
        }
    </style>
</head>
<body class="light-theme">
    <div class="container">
        <!-- Top Navigation -->
        <nav class="top-nav">
            <div class="nav-left">
                <div class="app-title">
                    <i class="fas fa-gamepad"></i>
                    <h1>Life Game</h1>
                </div>
                <div class="nav-items">
                    <a href="#" class="nav-item active" data-tab="projects">
                        <i class="fas fa-bullseye"></i>
                        <span class="nav-text">Проекты</span>
                    </a>
                    <a href="#" class="nav-item" data-tab="habits">
                        <i class="fas fa-redo"></i>
                        <span class="nav-text">Привычки</span>
                    </a>
                    <a href="#" class="nav-item" data-tab="stats">
                        <i class="fas fa-chart-line"></i>
                        <span class="nav-text">Статистика</span>
                    </a>
                    <a href="#" class="nav-item" data-tab="achievements">
                        <i class="fas fa-trophy"></i>
                        <span class="nav-text">Ачивки</span>
                    </a>
                </div>
            </div>
            <div class="nav-right">
                <div class="xp-display">
                    <div class="level-badge">
                        <span class="level-label">Уровень</span>
                        <span id="level" class="level-value">1</span>
                    </div>
                    <div class="xp-progress">
                        <div class="xp-bar">
                            <div id="xp-progress-fill" class="xp-fill"></div>
                        </div>
                        <span id="xp-text" class="xp-text">0/100 XP</span>
                    </div>
                    <div class="coins-display">
                        <i class="fas fa-coins"></i>
                        <span id="coins">0</span>
                    </div>
                </div>
                <button class="icon-btn" id="theme-toggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="icon-btn" id="settings-btn">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </nav>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Projects Section -->
            <section id="projects-section" class="content-section active">
                <div class="section-header">
                    <div>
                        <h2>Мои проекты</h2>
                        <p class="section-subtitle">Отслеживайте прогресс по вашим целям</p>
                    </div>
                    <button class="btn btn-primary" id="new-project-btn">
                        <i class="fas fa-plus"></i> <span class="btn-text">Новый проект</span>
                    </button>
                </div>

                <div class="filters">
                    <div class="filter-group">
                        <label for="category-filter" class="filter-label">Категория</label>
                        <select id="category-filter" class="filter-select">
                            <option value="all">Все</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status-filter" class="filter-label">Статус</label>
                        <select id="status-filter" class="filter-select">
                            <option value="all">Все</option>
                            <option value="active">Активные</option>
                            <option value="completed">Завершённые</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sort-by" class="filter-label">Сортировка</label>
                        <select id="sort-by" class="filter-select">
                            <option value="deadline">По дедлайну</option>
                            <option value="progress">По прогрессу</option>
                            <option value="name">По названию</option>
                        </select>
                    </div>
                </div>

                <div class="projects-grid" id="projects-grid">
                    <!-- Projects will be dynamically added here -->
                </div>
            </section>

            <!-- Habits Section -->
            <section id="habits-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2>Мои привычки</h2>
                        <p class="section-subtitle">Ежедневные и еженедельные рутины</p>
                    </div>
                    <button class="btn btn-primary" id="new-habit-btn">
                        <i class="fas fa-plus"></i> <span class="btn-text">Новая привычка</span>
                    </button>
                </div>

                <div class="habits-container">
                    <div class="today-habits">
                        <h3>Сегодня</h3>
                        <div id="today-habits-list" class="habits-list">
                            <!-- Today's habits will be added here -->
                        </div>
                    </div>
                    <div class="weekly-overview">
                        <h3>Недельный обзор</h3>
                        <div id="week-grid" class="week-grid">
                            <!-- Week grid will be added here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Stats Section -->
            <section id="stats-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2>Статистика</h2>
                        <p class="section-subtitle">Ваш прогресс в цифрах</p>
                    </div>
                    <select id="stats-period" class="filter-select">
                        <option value="week">Неделя</option>
                        <option value="month">Месяц</option>
                        <option value="all">Всё время</option>
                    </select>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="streak">0</div>
                            <div class="stat-label">Дней подряд</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="completed-tasks">0</div>
                            <div class="stat-label">Выполнено задач</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="active-projects">0</div>
                            <div class="stat-label">Активных проектов</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="stat-info">
                            <div class="stat-value" id="total-coins">0</div>
                            <div class="stat-label">Всего монет</div>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>Прогресс проектов</h3>
                    <div id="projects-progress" class="progress-list">
                        <!-- Project progress bars will be added here -->
                    </div>
                </div>
            </section>

            <!-- Achievements Section -->
            <section id="achievements-section" class="content-section">
                <div class="section-header">
                    <div>
                        <h2>Ачивки</h2>
                        <p class="section-subtitle">Достижения и награды</p>
                    </div>
                    <div class="achievement-summary">
                        <span id="achieved-count">0</span> из <span id="total-achievements">0</span>
                    </div>
                </div>

                <div class="achievements-grid" id="achievements-grid">
                    <!-- Achievements will be added here -->
                </div>
            </section>

            <!-- Settings Panel -->
            <div id="settings-panel" class="settings-panel">
                <div class="settings-header">
                    <h3>Настройки</h3>
                    <button class="icon-btn close-settings">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="settings-content">
                    <div class="setting-group">
                        <h4>Внешний вид</h4>
                        <div class="theme-options">
                            <button class="theme-option active" data-theme="light">
                                <i class="fas fa-sun"></i>
                                <span>Светлая</span>
                            </button>
                            <button class="theme-option" data-theme="dark">
                                <i class="fas fa-moon"></i>
                                <span>Тёмная</span>
                            </button>
                        </div>
                    </div>

                    <div class="setting-group">
                        <h4>Категории</h4>
                        <div id="categories-list" class="categories-list">
                            <!-- Categories will be added here -->
                        </div>
                        <div class="add-category">
                            <input type="text" id="new-category" placeholder="Новая категория">
                            <input type="color" id="category-color" value="#007AFF">
                            <button id="add-category-btn" class="btn btn-secondary">Добавить</button>
                        </div>
                    </div>

                    <div class="setting-group">
                        <h4>Данные</h4>
                        <div class="data-actions">
                            <button id="export-btn" class="btn btn-secondary">
                                <i class="fas fa-download"></i> <span>Экспорт данных</span>
                            </button>
                            <button id="import-btn" class="btn btn-secondary">
                                <i class="fas fa-upload"></i> <span>Импорт данных</span>
                            </button>
                            <button id="fix-xp-btn" class="btn btn-warning">
                                <i class="fas fa-wrench"></i> <span>Исправить XP</span>
                            </button>
                            <button id="reset-btn" class="btn btn-danger">
                                <i class="fas fa-trash"></i> <span>Сбросить данные</span>
                            </button>
                        </div>
                        <input type="file" id="import-file" accept=".json" style="display: none;">
                    </div>
                </div>
            </div>

            <!-- Mobile Navigation -->
            <div id="mobile-nav" class="mobile-nav-overlay">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-header">
                        <h3>Life Game</h3>
                        <button class="icon-btn close-mobile-nav">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mobile-nav-items">
                        <a href="#" class="mobile-nav-item active" data-tab="projects">
                            <i class="fas fa-bullseye"></i>
                            <span>Проекты</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-tab="habits">
                            <i class="fas fa-redo"></i>
                            <span>Привычки</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-tab="stats">
                            <i class="fas fa-chart-line"></i>
                            <span>Статистика</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-tab="achievements">
                            <i class="fas fa-trophy"></i>
                            <span>Ачивки</span>
                        </a>
                        <a href="#" class="mobile-nav-item" id="mobile-settings-btn">
                            <i class="fas fa-cog"></i>
                            <span>Настройки</span>
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modals -->
        <div id="project-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Новый проект</h3>
                    <button class="icon-btn close-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="project-form">
                    <div class="form-group">
                        <label for="project-name">Название проекта</label>
                        <input type="text" id="project-name" required>
                    </div>
                    <div class="form-group">
                        <label for="project-description">Описание (необязательно)</label>
                        <textarea id="project-description" rows="3"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="project-category">Категория</label>
                            <select id="project-category" class="form-select">
                                <!-- Categories will be populated -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="project-deadline">Дедлайн</label>
                            <input type="date" id="project-deadline">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Задачи проекта</label>
                        <div id="tasks-container">
                            <div class="task-input">
                                <input type="text" class="task-name" placeholder="Название задачи" required>
                                <input type="number" class="task-xp" placeholder="XP" min="1" value="10">
                                <button type="button" class="btn-icon remove-task">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" id="add-task-btn" class="btn btn-secondary">
                            <i class="fas fa-plus"></i> Добавить задачу
                        </button>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Создать проект</button>
                        <button type="button" class="btn btn-secondary close-modal">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="habit-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Новая привычка</h3>
                    <button class="icon-btn close-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <form id="habit-form">
                    <div class="form-group">
                        <label for="habit-name">Название привычки</label>
                        <input type="text" id="habit-name" required>
                    </div>
                    <div class="form-group">
                        <label for="habit-category">Категория</label>
                        <select id="habit-category" class="form-select">
                            <!-- Categories will be populated -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="habit-xp">XP за выполнение</label>
                        <input type="number" id="habit-xp" min="1" value="10">
                    </div>
                    <div class="form-group">
                        <label>Тип привычки</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="habit-type" value="daily" checked>
                                <span>Ежедневная</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="habit-type" value="weekly">
                                <span>Еженедельная</span>
                            </label>
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="submit" class="btn btn-primary">Создать привычку</button>
                        <button type="button" class="btn btn-secondary close-modal">Отмена</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Notification Toast -->
        <div id="toast" class="toast"></div>
    </div>

    <script>
        // Основной класс приложения
        class LifeGame {
            constructor() {
                this.version = 3; // Увеличил версию для очистки старых данных
                this.dataKey = 'lifeGameData';
                this.categories = [
                    { id: 'work', name: 'Работа', color: '#007AFF' },
                    { id: 'health', name: 'Здоровье', color: '#34C759' },
                    { id: 'learning', name: 'Обучение', color: '#AF52DE' },
                    { id: 'personal', name: 'Личное', color: '#FF9500' }
                ];
                
                this.achievements = [
                    { id: 1, title: 'Первый шаг', description: 'Выполни первую задачу', icon: '🚀', earned: false },
                    { id: 2, title: 'Неделя без пропусков', description: '7 дней подряд с активностью', icon: '🔥', earned: false },
                    { id: 3, title: 'Проект завершён', description: 'Заверши свой первый проект', icon: '🏆', earned: false },
                    { id: 4, title: 'Мастер привычек', description: 'Выполняй все привычки неделю', icon: '💪', earned: false },
                    { id: 5, title: 'Уровень 5', description: 'Достигни 5 уровня', icon: '⭐', earned: false },
                    { id: 6, title: 'Стратег', description: 'Создай 5 проектов', icon: '♟️', earned: false },
                    { id: 7, title: 'Дисциплинированный', description: 'Выполняй все привычки 30 дней подряд', icon: '📅', earned: false },
                    { id: 8, title: 'Трудоголик', description: 'Выполни 100 задач', icon: '💼', earned: false },
                    { id: 9, title: 'Богач', description: 'Заработай 1000 монет', icon: '💰', earned: false },
                    { id: 10, title: 'Легенда', description: 'Достигни 20 уровня', icon: '👑', earned: false },
                    { id: 11, title: 'Фотограф недели', description: 'Сделай 10 фото за неделю', icon: '📸', earned: false },
                    { id: 12, title: 'Кодер месяца', description: 'Выполни 50 задач по программированию', icon: '💻', earned: false },
                    { id: 13, title: 'Мастер монтажа', description: 'Смонтируй 5 видео', icon: '🎬', earned: false },
                    { id: 14, title: 'ЗОЖник', description: '30 дней подряд соблюдай привычки здоровья', icon: '🍎', earned: false },
                    { id: 15, title: 'Книжный червь', description: 'Прочитай 10 книг', icon: '📚', earned: false }
                ];
                
                this.init();
            }

            // Инициализация приложения
            init() {
                this.loadData();
                this.setupEventListeners();
                this.setupDefaultCategories();
                this.renderProjects();
                this.renderHabits();
                this.renderAchievements();
                this.updateStats();
                this.checkDailyReset();
                this.setupMobileMenu();
                this.showToast('Добро пожаловать в Life Game!', 'success');
            }

            // Загрузка данных из localStorage
            loadData() {
                const saved = localStorage.getItem(this.dataKey);
                if (saved) {
                    try {
                        const data = JSON.parse(saved);
                        
                        // Если версия старая, создаем новые данные
                        if (!data.version || data.version < this.version) {
                            console.log('Обнаружены старые данные, создаем новые');
                            this.createDefaultData();
                        } else {
                            this.data = data;
                        }
                    } catch (e) {
                        console.error('Ошибка загрузки данных:', e);
                        this.createDefaultData();
                    }
                } else {
                    this.createDefaultData();
                }
                
                // Устанавливаем тему
                this.setTheme(this.data.user.theme || 'light');
            }

            // Создание данных по умолчанию
            createDefaultData() {
                this.data = {
                    version: this.version,
                    user: {
                        level: 1,
                        xp: 0,
                        totalXP: 0,
                        xpToNextLevel: 100,
                        coins: 0,
                        streak: 0,
                        maxStreak: 0,
                        lastActive: new Date().toISOString().split('T')[0],
                        theme: 'light'
                    },
                    projects: [],
                    habits: [],
                    achievements: this.achievements.map(a => ({ ...a })),
                    stats: {
                        totalDays: 1,
                        completedTasks: 0,
                        completedProjects: 0,
                        totalHabits: 0
                    }
                };
                this.saveData();
            }

            // Сохранение данных
            saveData() {
                localStorage.setItem(this.dataKey, JSON.stringify(this.data));
            }

            // Настройка обработчиков событий
            setupEventListeners() {
                // Навигация
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = item.dataset.tab;
                        this.showTab(tab);
                    });
                });

                // Переключение темы
                document.getElementById('theme-toggle').addEventListener('click', () => {
                    this.toggleTheme();
                });

                // Кнопка настроек
                document.getElementById('settings-btn').addEventListener('click', () => {
                    document.getElementById('settings-panel').classList.add('active');
                    this.renderCategories();
                    this.setupThemeOptions();
                });

                // Закрытие настроек
                document.querySelector('.close-settings').addEventListener('click', () => {
                    document.getElementById('settings-panel').classList.remove('active');
                });

                // Создание проекта
                document.getElementById('new-project-btn').addEventListener('click', () => {
                    this.showProjectModal();
                });

                // Создание привычки
                document.getElementById('new-habit-btn').addEventListener('click', () => {
                    this.showHabitModal();
                });

                // Фильтры проектов
                document.getElementById('category-filter').addEventListener('change', () => {
                    this.renderProjects();
                });
                
                document.getElementById('status-filter').addEventListener('change', () => {
                    this.renderProjects();
                });
                
                document.getElementById('sort-by').addEventListener('change', () => {
                    this.renderProjects();
                });

                // Добавление категории
                document.getElementById('add-category-btn').addEventListener('click', () => {
                    this.addCategory();
                });

                // Экспорт данных
                document.getElementById('export-btn').addEventListener('click', () => {
                    this.exportData();
                });

                // Импорт данных
                document.getElementById('import-btn').addEventListener('click', () => {
                    document.getElementById('import-file').click();
                });

                document.getElementById('import-file').addEventListener('change', (e) => {
                    this.importData(e);
                });

                // Исправление XP
                document.getElementById('fix-xp-btn').addEventListener('click', () => {
                    this.fixXP();
                });

                // Сброс данных
                document.getElementById('reset-btn').addEventListener('click', () => {
                    if (confirm('Вы уверены? Все данные будут удалены.')) {
                        localStorage.clear();
                        location.reload();
                    }
                });

                // Закрытие модальных окон
                document.querySelectorAll('.close-modal').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.modal').forEach(modal => {
                            modal.classList.remove('active');
                        });
                    });
                });
            }

            // Настройка мобильного меню
            setupMobileMenu() {
                const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
                const mobileNav = document.getElementById('mobile-nav');
                const closeMobileNav = document.querySelector('.close-mobile-nav');
                const mobileNavItems = document.querySelectorAll('.mobile-nav-item');
                const mobileSettingsBtn = document.getElementById('mobile-settings-btn');
                
                if (mobileMenuToggle) {
                    mobileMenuToggle.addEventListener('click', () => {
                        mobileNav.classList.add('active');
                    });
                }
                
                if (closeMobileNav) {
                    closeMobileNav.addEventListener('click', () => {
                        mobileNav.classList.remove('active');
                    });
                }
                
                if (mobileSettingsBtn) {
                    mobileSettingsBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        mobileNav.classList.remove('active');
                        document.getElementById('settings-panel').classList.add('active');
                        this.renderCategories();
                    });
                }
                
                mobileNavItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const tab = item.dataset.tab;
                        if (tab) {
                            this.showTab(tab);
                            mobileNav.classList.remove('active');
                        }
                    });
                });
                
                // Закрытие мобильного меню при клике вне его
                mobileNav.addEventListener('click', (e) => {
                    if (e.target === mobileNav) {
                        mobileNav.classList.remove('active');
                    }
                });
            }

            // Настройка кнопок темы
            setupThemeOptions() {
                const themeOptions = document.querySelectorAll('.theme-option');
                const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                
                themeOptions.forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.theme === currentTheme) {
                        option.classList.add('active');
                    }
                    
                    option.addEventListener('click', () => {
                        const theme = option.dataset.theme;
                        this.setTheme(theme);
                    });
                });
            }

            // Установка темы
            setTheme(theme) {
                const body = document.body;
                const themeBtn = document.getElementById('theme-toggle');
                
                if (theme === 'dark') {
                    body.classList.remove('light-theme');
                    body.classList.add('dark-theme');
                    themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                } else {
                    body.classList.remove('dark-theme');
                    body.classList.add('light-theme');
                    themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                }
                
                // Обновляем активные кнопки в настройках
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.remove('active');
                    if (opt.dataset.theme === theme) {
                        opt.classList.add('active');
                    }
                });
                
                // Сохраняем тему в данные
                this.data.user.theme = theme;
                this.saveData();
            }

            // Переключение темы
            toggleTheme() {
                const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                this.showToast(`Тема "${newTheme === 'dark' ? 'тёмная' : 'светлая'}" включена`);
            }

            // Настройка категорий по умолчанию
            setupDefaultCategories() {
                const categorySelects = document.querySelectorAll('#project-category, #habit-category, #category-filter');
                categorySelects.forEach(select => {
                    if (select.id === 'category-filter') {
                        select.innerHTML = '<option value="all">Все категории</option>';
                    } else {
                        select.innerHTML = '';
                    }
                    this.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        select.appendChild(option);
                    });
                });
            }

            // Проверка ежедневного сброса
            checkDailyReset() {
                const today = new Date().toISOString().split('T')[0];
                
                if (this.data.user.lastActive !== today) {
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    
                    // Проверяем стрик
                    if (this.data.user.lastActive === yesterdayStr) {
                        this.data.user.streak++;
                        if (this.data.user.streak > this.data.user.maxStreak) {
                            this.data.user.maxStreak = this.data.user.streak;
                        }
                    } else if (this.data.user.lastActive !== today) {
                        this.data.user.streak = 1;
                    }
                    
                    this.data.user.lastActive = today;
                    this.data.stats.totalDays++;
                    
                    // Сбрасываем ежедневные привычки
                    this.data.habits.forEach(habit => {
                        if (habit.type === 'daily') {
                            habit.completed = false;
                        }
                    });
                    
                    this.saveData();
                    this.renderHabits();
                    this.updateUI();
                }
            }

            // Добавление XP (ИСПРАВЛЕНО - без отрицательных значений)
            addXP(amount, source) {
                // Гарантируем, что amount положительный
                const xpToAdd = Math.max(1, Math.abs(amount));
                
                this.data.user.xp += xpToAdd;
                this.data.user.totalXP += xpToAdd;
                
                // Проверка нового уровня
                while (this.data.user.xp >= this.data.user.xpToNextLevel) {
                    this.data.user.xp -= this.data.user.xpToNextLevel;
                    this.data.user.level++;
                    this.data.user.xpToNextLevel = this.data.user.level * 100;
                    
                    // Награда за уровень
                    this.data.user.coins += this.data.user.level * 10;
                    this.showToast(`🎉 Уровень ${this.data.user.level}! +${this.data.user.level * 10} монет`, 'success');
                }
                
                // Добавляем монеты
                const coinsEarned = Math.max(1, Math.floor(xpToAdd / 5));
                this.data.user.coins += coinsEarned;
                
                this.saveData();
                this.updateUI();
                
                if (source) {
                    this.showToast(`+${xpToAdd} XP (${source})`, 'success');
                }
            }

            // Обновление UI (ИСПРАВЛЕНО)
            updateUI() {
                // Исправляем возможные ошибки в данных
                if (this.data.user.xp < 0) this.data.user.xp = 0;
                if (this.data.user.level < 1) this.data.user.level = 1;
                if (this.data.user.xpToNextLevel <= 0) this.data.user.xpToNextLevel = 100;
                
                // Обновляем информацию пользователя
                document.getElementById('level').textContent = this.data.user.level;
                document.getElementById('current-xp').textContent = this.data.user.xp;
                document.getElementById('needed-xp').textContent = this.data.user.xpToNextLevel;
                document.getElementById('coins').textContent = this.data.user.coins;
                
                // Обновляем прогресс-бар XP
                const xpPercent = (this.data.user.xp / this.data.user.xpToNextLevel) * 100;
                document.getElementById('xp-progress-fill').style.width = `${Math.min(xpPercent, 100)}%`;
                document.getElementById('xp-text').textContent = `${this.data.user.xp}/${this.data.user.xpToNextLevel} XP`;
                
                this.updateStats();
            }

            // Обновление статистики
            updateStats() {
                document.getElementById('streak').textContent = this.data.user.streak;
                document.getElementById('completed-tasks').textContent = this.data.stats.completedTasks;
                document.getElementById('active-projects').textContent = this.data.projects.filter(p => !p.completed).length;
                document.getElementById('total-coins').textContent = this.data.user.coins;
                
                this.renderProjectProgress();
            }

            // Рендеринг проектов (ИСПРАВЛЕНО)
            renderProjects() {
                const grid = document.getElementById('projects-grid');
                if (!grid) return;
                
                const categoryFilter = document.getElementById('category-filter').value;
                const statusFilter = document.getElementById('status-filter').value;
                const sortBy = document.getElementById('sort-by').value;
                
                // Фильтрация
                let projects = this.data.projects.filter(project => {
                    if (categoryFilter !== 'all' && project.category !== categoryFilter) {
                        return false;
                    }
                    
                    if (statusFilter === 'active' && project.completed) {
                        return false;
                    }
                    
                    if (statusFilter === 'completed' && !project.completed) {
                        return false;
                    }
                    
                    return true;
                });
                
                // Сортировка
                projects.sort((a, b) => {
                    switch (sortBy) {
                        case 'progress':
                            return this.getProjectProgress(b) - this.getProjectProgress(a);
                        case 'name':
                            return a.title.localeCompare(b.title);
                        case 'deadline':
                        default:
                            if (!a.deadline && !b.deadline) return 0;
                            if (!a.deadline) return 1;
                            if (!b.deadline) return -1;
                            return new Date(a.deadline) - new Date(b.deadline);
                    }
                });
                
                // Рендеринг
                grid.innerHTML = projects.map(project => {
                    const progress = this.getProjectProgress(project);
                    const category = this.categories.find(c => c.id === project.category);
                    const isOverdue = project.deadline && new Date(project.deadline) < new Date() && !project.completed;
                    const isSoon = project.deadline && !project.completed && 
                                  new Date(project.deadline) > new Date() && 
                                  new Date(project.deadline) - new Date() < 7 * 24 * 60 * 60 * 1000;
                    
                    return `
                        <div class="project-card" data-project-id="${project.id}">
                            <div class="project-header">
                                <div>
                                    <h3 class="project-title">${project.title}</h3>
                                    <span class="project-category" style="background-color: ${category?.color}20; color: ${category?.color}">
                                        ${category?.name || 'Без категории'}
                                    </span>
                                </div>
                                <div class="project-actions">
                                    <button class="btn-icon" onclick="game.toggleProject(${project.id})" title="${project.completed ? 'Возобновить' : 'Завершить'}">
                                        <i class="fas fa-${project.completed ? 'redo' : 'check'}"></i>
                                    </button>
                                    <button class="btn-icon" onclick="game.deleteProject(${project.id})" title="Удалить">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            ${project.description ? `<p class="project-description">${project.description}</p>` : ''}
                            
                            <div class="project-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%; background-color: ${category?.color || '#007AFF'}"></div>
                                </div>
                                <div class="progress-text">
                                    <span>Прогресс</span>
                                    <span id="project-progress-${project.id}">${progress}%</span>
                                </div>
                            </div>
                            
                            <div class="project-deadline">
                                <i class="far fa-calendar"></i>
                                ${project.deadline ? 
                                    `До ${new Date(project.deadline).toLocaleDateString('ru-RU')}` : 
                                    'Без дедлайна'
                                }
                                ${isOverdue ? '<span class="deadline-overdue"> • Просрочено</span>' : ''}
                                ${isSoon && !isOverdue ? '<span class="deadline-soon"> • Скоро дедлайн</span>' : ''}
                            </div>
                            
                            <div class="project-tasks">
                                <h4>Задачи (${this.getCompletedTasksCount(project)}/${project.tasks?.length || 0})</h4>
                                ${project.tasks && project.tasks.length > 0 ? `
                                    <ul>
                                        ${project.tasks.map((task, index) => `
                                            <li class="task-item ${task.completed ? 'completed' : ''}" 
                                                data-task-index="${index}">
                                                <div class="task-checkbox ${task.completed ? 'checked' : ''}" 
                                                     onclick="game.toggleTask(${project.id}, ${index})">
                                                    ${task.completed ? '<i class="fas fa-check"></i>' : ''}
                                                </div>
                                                <span class="task-text">${task.title}</span>
                                                <span class="task-xp-badge">+${task.xp || 10} XP</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                ` : '<p style="opacity: 0.7; font-style: italic;">Нет задач</p>'}
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (projects.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>Нет проектов</h3>
                            <p>Создайте свой первый проект!</p>
                            <button class="btn btn-primary" onclick="game.showProjectModal()">
                                <i class="fas fa-plus"></i> Создать проект
                            </button>
                        </div>
                    `;
                }
            }

            // Получение прогресса проекта
            getProjectProgress(project) {
                if (!project.tasks || project.tasks.length === 0) return 0;
                const completed = project.tasks.filter(t => t.completed).length;
                return Math.round((completed / project.tasks.length) * 100);
            }

            // Получение количества выполненных задач
            getCompletedTasksCount(project) {
                return project.tasks ? project.tasks.filter(t => t.completed).length : 0;
            }

            // Переключение задачи (ИСПРАВЛЕНО - мгновенное обновление)
            toggleTask(projectId, taskIndex) {
                const project = this.data.projects.find(p => p.id == projectId);
                if (!project || !project.tasks || !project.tasks[taskIndex]) {
                    console.error('Project or task not found');
                    return;
                }
                
                const task = project.tasks[taskIndex];
                const wasCompleted = task.completed;
                task.completed = !task.completed;
                
                // Начисление XP только при выполнении задачи (не при снятии)
                if (task.completed && !wasCompleted) {
                    const xpGained = task.xp || 10;
                    this.addXP(xpGained, `Задача: ${task.title}`);
                    this.data.stats.completedTasks++;
                } else if (!task.completed && wasCompleted) {
                    // При снятии галочки не отнимаем XP, только уменьшаем счетчик
                    this.data.stats.completedTasks = Math.max(0, this.data.stats.completedTasks - 1);
                }
                
                // Проверка завершения проекта
                const allCompleted = project.tasks.every(t => t.completed);
                if (allCompleted && !project.completed) {
                    project.completed = true;
                    this.data.stats.completedProjects++;
                    const bonusXP = project.tasks.length * 15;
                    this.addXP(bonusXP, `Завершение проекта: ${project.title}`);
                    this.showToast(`🎉 Проект "${project.title}" завершён!`, 'success');
                } else if (!allCompleted && project.completed) {
                    project.completed = false;
                    this.data.stats.completedProjects--;
                }
                
                this.saveData();
                
                // Мгновенное обновление UI
                this.updateTaskUI(projectId, taskIndex, task.completed);
                this.updateProjectProgress(projectId);
                this.updateUI();
            }

            // Обновление UI задачи (ИСПРАВЛЕНО)
            updateTaskUI(projectId, taskIndex, completed) {
                const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
                if (!projectCard) return;
                
                const taskItem = projectCard.querySelector(`[data-task-index="${taskIndex}"]`);
                if (!taskItem) return;
                
                // Обновляем чекбокс
                const checkbox = taskItem.querySelector('.task-checkbox');
                if (checkbox) {
                    checkbox.classList.toggle('checked', completed);
                    checkbox.innerHTML = completed ? '<i class="fas fa-check"></i>' : '';
                }
                
                // Обновляем текст задачи
                const taskText = taskItem.querySelector('.task-text');
                if (taskText) {
                    taskText.style.textDecoration = completed ? 'line-through' : 'none';
                    taskText.style.opacity = completed ? '0.6' : '1';
                }
            }

            // Обновление прогресса проекта (ИСПРАВЛЕНО)
            updateProjectProgress(projectId) {
                const project = this.data.projects.find(p => p.id == projectId);
                if (!project) return;
                
                const progress = this.getProjectProgress(project);
                const completedCount = this.getCompletedTasksCount(project);
                const totalCount = project.tasks?.length || 0;
                
                // Находим элементы по ID проекта
                const projectCard = document.querySelector(`[data-project-id="${projectId}"]`);
                if (!projectCard) return;
                
                // Обновляем прогресс в процентах
                const progressText = projectCard.querySelector('.progress-text span:last-child');
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
                
                // Обновляем прогресс-бар
                const progressFill = projectCard.querySelector('.progress-fill');
                if (progressFill) {
                    progressFill.style.width = `${progress}%`;
                }
                
                // Обновляем счетчик задач
                const taskCounter = projectCard.querySelector('h4');
                if (taskCounter) {
                    taskCounter.textContent = `Задачи (${completedCount}/${totalCount})`;
                }
            }

            // Переключение проекта (завершение/возобновление)
            toggleProject(projectId) {
                const project = this.data.projects.find(p => p.id == projectId);
                if (!project) return;
                
                project.completed = !project.completed;
                
                if (project.completed) {
                    this.data.stats.completedProjects++;
                    this.showToast(`Проект "${project.title}" завершён`);
                } else {
                    this.data.stats.completedProjects--;
                    this.showToast(`Проект "${project.title}" возобновлён`);
                }
                
                this.saveData();
                this.renderProjects();
                this.updateUI();
            }

            // Удаление проекта
            deleteProject(projectId) {
                if (confirm('Удалить проект? Это действие нельзя отменить.')) {
                    this.data.projects = this.data.projects.filter(p => p.id !== projectId);
                    this.saveData();
                    this.renderProjects();
                    this.showToast('Проект удалён');
                }
            }

            // Показать модальное окно проекта
            showProjectModal() {
                const modal = document.getElementById('project-modal');
                const form = document.getElementById('project-form');
                
                // Сброс формы
                form.reset();
                
                // Заполнение категорий
                const categorySelect = document.getElementById('project-category');
                categorySelect.innerHTML = '';
                this.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // Обработчик отправки формы
                form.onsubmit = (e) => {
                    e.preventDefault();
                    this.createProject();
                };
                
                // Обработчик добавления задачи
                document.getElementById('add-task-btn').onclick = () => {
                    this.addTaskInput();
                };
                
                // Инициализация с одной задачей
                const tasksContainer = document.getElementById('tasks-container');
                tasksContainer.innerHTML = `
                    <div class="task-input">
                        <input type="text" class="task-name" placeholder="Название задачи" required>
                        <input type="number" class="task-xp" placeholder="XP" min="1" value="10">
                        <button type="button" class="btn-icon remove-task" onclick="this.parentElement.remove()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                modal.classList.add('active');
            }

            // Добавление поля задачи
            addTaskInput() {
                const tasksContainer = document.getElementById('tasks-container');
                const taskDiv = document.createElement('div');
                taskDiv.className = 'task-input';
                taskDiv.innerHTML = `
                    <input type="text" class="task-name" placeholder="Название задачи" required>
                    <input type="number" class="task-xp" placeholder="XP" min="1" value="10">
                    <button type="button" class="btn-icon remove-task" onclick="this.parentElement.remove()">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                tasksContainer.appendChild(taskDiv);
            }

            // Создание проекта
            createProject() {
                const title = document.getElementById('project-name').value;
                const description = document.getElementById('project-description').value;
                const category = document.getElementById('project-category').value;
                const deadline = document.getElementById('project-deadline').value;
                
                // Сбор задач
                const taskInputs = document.querySelectorAll('.task-input');
                const tasks = Array.from(taskInputs).map(input => {
                    return {
                        title: input.querySelector('.task-name').value,
                        xp: parseInt(input.querySelector('.task-xp').value) || 10,
                        completed: false
                    };
                });
                
                const newProject = {
                    id: Date.now(),
                    title,
                    description,
                    category,
                    deadline: deadline || null,
                    completed: false,
                    tasks,
                    createdAt: new Date().toISOString()
                };
                
                this.data.projects.push(newProject);
                this.saveData();
                this.renderProjects();
                
                // Закрытие модального окна
                document.getElementById('project-modal').classList.remove('active');
                
                this.showToast(`Проект "${title}" создан`, 'success');
            }

            // Рендеринг привычек (ИСПРАВЛЕНО)
            renderHabits() {
                const todayList = document.getElementById('today-habits-list');
                const weekGrid = document.getElementById('week-grid');
                
                if (!todayList || !weekGrid) return;
                
                // Сегодняшние привычки
                const todayHabits = this.data.habits.filter(habit => habit.type === 'daily');
                todayList.innerHTML = todayHabits.map(habit => {
                    const category = this.categories.find(c => c.id === habit.category);
                    
                    return `
                        <div class="habit-item" data-habit-id="${habit.id}" onclick="game.toggleHabit(${habit.id})">
                            <div class="habit-checkbox ${habit.completed ? 'checked' : ''}">
                                ${habit.completed ? '<i class="fas fa-check"></i>' : ''}
                            </div>
                            <div class="habit-info">
                                <div class="habit-name">${habit.title}</div>
                                <div class="habit-xp">+${habit.xp} XP</div>
                            </div>
                            <span class="project-category" style="background-color: ${category?.color}20; color: ${category?.color}; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                ${category?.name || 'Без категории'}
                            </span>
                        </div>
                    `;
                }).join('');
                
                if (todayHabits.length === 0) {
                    todayList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-redo"></i>
                            <p>Нет привычек на сегодня</p>
                            <button class="btn btn-secondary" onclick="game.showHabitModal()">
                                <i class="fas fa-plus"></i> Добавить привычку
                            </button>
                        </div>
                    `;
                }
                
                // Недельная сетка (упрощенная версия)
                const days = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
                weekGrid.innerHTML = days.map(day => `
                    <div class="week-day">
                        ${day}
                    </div>
                `).join('');
            }

            // Переключение привычки (ИСПРАВЛЕНО - работает!)
            toggleHabit(habitId) {
                const habit = this.data.habits.find(h => h.id == habitId);
                if (!habit) {
                    console.error('Habit not found with ID:', habitId);
                    return;
                }
                
                // Сохраняем предыдущее состояние
                const wasCompleted = habit.completed;
                
                // Переключаем состояние
                habit.completed = !habit.completed;
                
                // Начисляем XP только при выполнении (не при снятии)
                if (habit.completed && !wasCompleted) {
                    this.addXP(habit.xp, `Привычка: ${habit.title}`);
                    this.data.stats.totalHabits++;
                } else if (!habit.completed && wasCompleted) {
                    // При снятии галочки не отнимаем XP, только уменьшаем счетчик
                    this.data.stats.totalHabits = Math.max(0, this.data.stats.totalHabits - 1);
                }
                
                this.saveData();
                
                // Обновляем визуальное состояние
                const habitItem = document.querySelector(`[data-habit-id="${habit.id}"]`);
                if (habitItem) {
                    const checkbox = habitItem.querySelector('.habit-checkbox');
                    if (checkbox) {
                        checkbox.classList.toggle('checked', habit.completed);
                        checkbox.innerHTML = habit.completed ? '<i class="fas fa-check"></i>' : '';
                    }
                }
                
                this.updateUI();
            }

            // Показать модальное окно привычки
            showHabitModal() {
                const modal = document.getElementById('habit-modal');
                const form = document.getElementById('habit-form');
                
                // Сброс формы
                form.reset();
                
                // Заполнение категорий
                const categorySelect = document.getElementById('habit-category');
                categorySelect.innerHTML = '';
                this.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                // Обработчик отправки формы
                form.onsubmit = (e) => {
                    e.preventDefault();
                    this.createHabit();
                };
                
                modal.classList.add('active');
            }

            // Создание привычки
            createHabit() {
                const title = document.getElementById('habit-name').value;
                const category = document.getElementById('habit-category').value;
                const xp = parseInt(document.getElementById('habit-xp').value) || 10;
                const type = document.querySelector('input[name="habit-type"]:checked').value;
                
                const newHabit = {
                    id: Date.now(),
                    title,
                    category,
                    xp,
                    type,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                this.data.habits.push(newHabit);
                this.saveData();
                this.renderHabits();
                
                // Закрытие модального окна
                document.getElementById('habit-modal').classList.remove('active');
                
                this.showToast(`Привычка "${title}" создана`, 'success');
            }

            // Рендеринг ачивок
            renderAchievements() {
                const grid = document.getElementById('achievements-grid');
                if (!grid) return;
                
                const achieved = this.data.achievements.filter(a => a.earned).length;
                const total = this.data.achievements.length;
                
                document.getElementById('achieved-count').textContent = achieved;
                document.getElementById('total-achievements').textContent = total;
                
                grid.innerHTML = this.data.achievements.map(achievement => {
                    return `
                        <div class="achievement-card ${achievement.earned ? 'earned' : 'locked'}">
                            <div class="achievement-icon">${achievement.icon}</div>
                            <div class="achievement-title">${achievement.title}</div>
                            <div class="achievement-desc">${achievement.description}</div>
                            <div class="achievement-status">
                                ${achievement.earned ? '🎉 Получено' : '🔒 Заблокировано'}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Разблокировка ачивки
            unlockAchievement(achievementId) {
                const achievement = this.data.achievements.find(a => a.id === achievementId);
                if (achievement && !achievement.earned) {
                    achievement.earned = true;
                    this.saveData();
                    this.renderAchievements();
                    this.showToast(`🏆 Ачивка получена: ${achievement.title}`, 'success');
                }
            }

            // Рендеринг прогресса проектов
            renderProjectProgress() {
                const container = document.getElementById('projects-progress');
                if (!container) return;
                
                const activeProjects = this.data.projects.filter(p => !p.completed);
                
                container.innerHTML = activeProjects.map(project => {
                    const progress = this.getProjectProgress(project);
                    const category = this.categories.find(c => c.id === project.category);
                    
                    return `
                        <div class="project-progress-item">
                            <div class="progress-header">
                                <span>${project.title}</span>
                                <span>${progress}%</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress}%; background-color: ${category?.color || '#007AFF'}"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                if (activeProjects.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #8E8E93;">Нет активных проектов</p>';
                }
            }

            // Рендеринг категорий в настройках
            renderCategories() {
                const container = document.getElementById('categories-list');
                if (!container) return;
                
                container.innerHTML = this.categories.map(category => `
                    <div class="category-item">
                        <div class="category-color" style="background-color: ${category.color}"></div>
                        <span class="category-name">${category.name}</span>
                        ${this.categories.length > 1 ? `
                            <button class="btn-icon" onclick="game.deleteCategory('${category.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            }

            // Добавление категории
            addCategory() {
                const nameInput = document.getElementById('new-category');
                const colorInput = document.getElementById('category-color');
                
                const name = nameInput.value.trim();
                const color = colorInput.value;
                
                if (!name) {
                    this.showToast('Введите название категории', 'error');
                    return;
                }
                
                const newCategory = {
                    id: name.toLowerCase().replace(/\s+/g, '-'),
                    name,
                    color
                };
                
                this.categories.push(newCategory);
                this.setupDefaultCategories();
                this.renderCategories();
                this.renderProjects();
                this.renderHabits();
                
                // Сброс полей
                nameInput.value = '';
                colorInput.value = '#007AFF';
                
                this.showToast(`Категория "${name}" добавлена`, 'success');
            }

            // Удаление категории
            deleteCategory(categoryId) {
                if (this.categories.length <= 1) {
                    this.showToast('Должна быть хотя бы одна категория', 'error');
                    return;
                }
                
                this.categories = this.categories.filter(c => c.id !== categoryId);
                this.setupDefaultCategories();
                this.renderCategories();
                this.renderProjects();
                this.renderHabits();
                this.showToast('Категория удалена');
            }

            // Экспорт данных
            exportData() {
                const data = {
                    ...this.data,
                    categories: this.categories
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `life-game-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showToast('Данные экспортированы', 'success');
            }

            // Импорт данных
            importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (confirm('Заменить текущие данные импортированными?')) {
                            if (importedData.categories) {
                                this.categories = importedData.categories;
                            }
                            
                            this.data = importedData;
                            this.saveData();
                            this.setupDefaultCategories();
                            this.renderProjects();
                            this.renderHabits();
                            this.renderAchievements();
                            this.updateUI();
                            
                            this.showToast('Данные импортированы', 'success');
                        }
                    } catch (error) {
                        this.showToast('Ошибка при импорте данных', 'error');
                        console.error('Import error:', error);
                    }
                };
                reader.readAsText(file);
                
                // Сброс input
                event.target.value = '';
            }

            // Исправление XP (новая функция)
            fixXP() {
                if (confirm('Исправить XP и уровни? Это исправит возможные ошибки в данных.')) {
                    // Исправляем отрицательные значения
                    if (this.data.user.xp < 0) this.data.user.xp = 0;
                    if (this.data.user.totalXP < 0) this.data.user.totalXP = 0;
                    if (this.data.user.coins < 0) this.data.user.coins = 0;
                    
                    // Пересчитываем уровень на основе totalXP
                    let tempXP = Math.max(0, this.data.user.totalXP);
                    let level = 1;
                    let xpNeeded = 100;
                    
                    while (tempXP >= xpNeeded) {
                        tempXP -= xpNeeded;
                        level++;
                        xpNeeded = level * 100;
                    }
                    
                    this.data.user.level = level;
                    this.data.user.xp = tempXP;
                    this.data.user.xpToNextLevel = xpNeeded;
                    
                    // Исправляем статистику
                    if (this.data.stats.completedTasks < 0) this.data.stats.completedTasks = 0;
                    if (this.data.stats.completedProjects < 0) this.data.stats.completedProjects = 0;
                    if (this.data.stats.totalHabits < 0) this.data.stats.totalHabits = 0;
                    
                    this.saveData();
                    this.updateUI();
                    this.showToast('XP и уровни исправлены!', 'success');
                }
            }

            // Показать секцию
            showTab(tabName) {
                // Скрыть все секции
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });

                // Убрать активный класс у всех навигационных элементов
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                document.querySelectorAll('.mobile-nav-item').forEach(item => {
                    item.classList.remove('active');
                });

                // Показать выбранную вкладку
                const section = document.getElementById(`${tabName}-section`);
                if (section) {
                    section.classList.add('active');
                }

                // Активировать соответствующий навигационный элемент
                document.querySelector(`.nav-item[data-tab="${tabName}"]`)?.classList.add('active');
                document.querySelector(`.mobile-nav-item[data-tab="${tabName}"]`)?.classList.add('active');
            }

            // Показать toast-уведомление
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast show';
                
                // Стиль в зависимости от типа
                if (type === 'success') {
                    toast.style.backgroundColor = '#34C759';
                } else if (type === 'error') {
                    toast.style.backgroundColor = '#FF3B30';
                } else if (type === 'info') {
                    toast.style.backgroundColor = '#007AFF';
                }
                
                // Автоматическое скрытие
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // Инициализация приложения
        let game;

        document.addEventListener('DOMContentLoaded', () => {
            game = new LifeGame();
            
            // Глобальные функции для использования в HTML
            window.game = game;
            
            // Закрытие модальных окон по клавише ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                    document.getElementById('settings-panel').classList.remove('active');
                    document.getElementById('mobile-nav').classList.remove('active');
                }
            });
            
            // Закрытие модальных окон при клике вне
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
